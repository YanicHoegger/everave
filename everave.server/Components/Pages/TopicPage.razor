@page "/topic/{id}/{page?}"
@rendermode InteractiveServer
@using everave.server.Forum
@using everave.server.UserManagement
@using MongoDB.Bson
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@inject IForumService ForumService
@inject AuthenticationStateProvider AuthProvider
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

@if (entries == null)
{
    <p>Loading...</p>
}
else
{
    <AuthorizeView>
        @if (!isAdding)
        {
            <button class="btn btn-primary" @onclick="AddEntry">Antworten</button>
        }
    </AuthorizeView>

    <div class="pagination d-flex align-items-center justify-content-end">
        @if (totalPages > 1)
        {
            <button class="btn btn-sm btn-outline-secondary me-1" disabled="@IsCurrentPage(1)" @onclick="() => NavigateToPage(1)">1</button>
            var currentPage = GetCurrentPage();
            @if (currentPage > 3)
            {
                <span class="text-muted me-1">...</span>
            }

            @foreach (var pageNumber in GetVisiblePages())
            {
                <button class="btn btn-sm btn-outline-secondary me-1" disabled="@IsCurrentPage(pageNumber)" @onclick="() => NavigateToPage(pageNumber)">@pageNumber</button>
            }

            @if (currentPage < totalPages - 2)
            {
                <span class="text-muted me-1">...</span>
            }

            <button class="btn btn-sm btn-outline-secondary" disabled="@IsCurrentPage(totalPages)" @onclick="() => NavigateToPage(totalPages)">@totalPages</button>
        }
    </div>

    foreach (var entry in entries)
    {
        <div class="entry-card d-flex mb-4">
            <!-- Creator Information -->
            <div class="creator-info text-center me-3">
                <img src="@entry.CreatorProfilePictureUrl" alt="Profile Picture" class="profile-picture mb-2" />
                <p class="creator-name">@entry.CreatorName</p>
            </div>

            <!-- Entry Content -->
            <div class="entry-content flex-grow-1">
                <div class="entry-header text-muted mb-2">
                    <small>Created at: @entry.CreatedAt.ToString("g")</small>
                </div>
                <div class="entry-body ck-content">
                    @((MarkupString)entry.HtmlContent)
                </div>
            </div>
        </div>
    }

    if (isAdding)
    {
        <div class="editor">
            <everave.server.Components.RichTextEditor @bind-Value="newContent" />
            <button class="btn btn-success mt-2" @onclick="SaveEntry">Speichern</button>
            <div id="richTextEditor"></div>
        </div>
    }
    else
    {
        <AuthorizeView>
            <button class="btn btn-primary" @onclick="AddEntry">Antworten</button>
        </AuthorizeView>
    }
}

@code {
    [Parameter]
    public string id { get; set; } = default!;
    [Parameter]
    public string? page { get; set; }

    private int totalEntries = 0;
    private int totalPages = 0;

    private List<EntryDisplay>? entries;
    private bool isAdding = false;
    private bool needsScrolling = true;
    private string newContent = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var rawEntries = await ForumService.GetEntriesByTopicIdAsync(new ObjectId(id), GetCurrentPage()).ConfigureAwait(false);
        entries = new List<EntryDisplay>();

        foreach (var entry in rawEntries)
        {
            var user = await UserManager.FindByIdAsync(entry.UserId.ToString()).ConfigureAwait(false);
            entries.Add(new EntryDisplay
                {
                    HtmlContent = entry.HtmlContent,
                    CreatedAt = entry.CreatedAt,
                    CreatorName = user?.UserName ?? "Unknown",
                    CreatorProfilePictureUrl = user?.ProfilePictureUrl ?? "/images/default-profile.png"
                });
        }

        if (rawEntries.Any())
        {
            totalEntries = (await ForumService.GetTopicByIdAsync(rawEntries.First().TopicId).ConfigureAwait(false)).NumberOfEntries;
            totalPages = (int)Math.Ceiling((double)totalEntries / ForumService.PageSize);
        }

        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);

        if (query.TryGetValue("isAdding", out var isAddingValue) && bool.TryParse(isAddingValue, out var isAddingResult))
        {
            isAdding = isAddingResult;

        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender).ConfigureAwait(false);
        if (isAdding && needsScrolling)
        {
            needsScrolling = false;
            await JSRuntime.InvokeVoidAsync("scrollToElement", "richTextEditor").ConfigureAwait(false);
        }
    }

    private async Task SaveEntry()
    {
        if (!string.IsNullOrWhiteSpace(newContent))
        {
            var entry = new Entry
                {
                    HtmlContent = newContent,
                    CreatedAt = DateTime.UtcNow,
                    TopicId = new ObjectId(id),
                    UserId = (ObjectId)(await AuthProvider.GetUserId())!
                };
            await ForumService.AddEntryAsync(entry);

            var user = await UserManager.FindByIdAsync(entry.UserId.ToString());
            entries!.Add(new EntryDisplay
                {
                    HtmlContent = entry.HtmlContent,
                    CreatedAt = entry.CreatedAt,
                    CreatorName = user?.UserName ?? "Unknown",
                    CreatorProfilePictureUrl = user?.ProfilePictureUrl ?? "/images/default-profile.png"
                });

            newContent = string.Empty;
            isAdding = false;
        }
    }

    private void AddEntry()
    {
        var currentPage = GetCurrentPage();
        if (currentPage != totalPages)
        {
            needsScrolling = false;
            NavigationManager.NavigateTo($"/topic/{id}/{totalPages}?isAdding=true");
        }
        else
        {
            needsScrolling = true;
            isAdding = true;
            StateHasChanged();
        }
    }

    private class EntryDisplay
    {
        public string HtmlContent { get; set; } = string.Empty;
        public DateTime CreatedAt { get; set; }
        public string CreatorName { get; set; } = string.Empty;
        public string CreatorProfilePictureUrl { get; set; } = string.Empty;
    }

    private IEnumerable<int> GetVisiblePages()
    {
        var page = GetCurrentPage();
        var start = Math.Max(2, page - 2);
        var end = Math.Min(totalPages - 1, page + 2);

        return Enumerable.Range(start, end - start + 1);
    }

    private int GetCurrentPage()
    {
        if (page != null && int.TryParse(page, out var parsedPage))
        {
            return parsedPage;
        }

        return 1;
    }

    private bool IsCurrentPage(int pageNumber) => pageNumber == GetCurrentPage();

    private void NavigateToPage(int pageNumber)
    {
        var currentPage = GetCurrentPage();
        if (pageNumber != currentPage)
        {
            currentPage = pageNumber;
            NavigationManager.NavigateTo($"/topic/{id}/{currentPage}");
        }
    }
}
